#!/bin/bash

export FAIRMQ_PATH=@FAIRMQ_BIN_DIR@

transport="zeromq"

if [[ $1 =~ ^[a-z]+$ ]]; then
    transport=$1
fi

ex2config="@CMAKE_CURRENT_BINARY_DIR@/ex-1-n-1.json"
SESSION="$(@CMAKE_BINARY_DIR@/fairmq/fairmq-uuid-gen -h)"

# setup a trap to kill everything if the test fails/timeouts
trap 'kill -TERM $SAMPLER_PID; kill -TERM $SINK_PID; kill -TERM $PROCESSOR1_PID; kill -TERM $PROCESSOR2_PID; wait $SAMPLER_PID; wait $SINK_PID; wait $PROCESSOR1_PID; wait $PROCESSOR2_PID;' TERM

SAMPLER="fairmq-ex-1-n-1-sampler"
SAMPLER+=" --id sampler1"
SAMPLER+=" --transport $transport"
SAMPLER+=" --verbosity veryhigh"
SAMPLER+=" --severity debug"
SAMPLER+=" --session $SESSION"
SAMPLER+=" --control static --color false"
# SAMPLER+=" --max-iterations 2"
SAMPLER+=" --mq-config $ex2config"
@CMAKE_CURRENT_BINARY_DIR@/$SAMPLER &
SAMPLER_PID=$!

i=0
pids=()
while [ $i -le 19 ]
do
    PROCESSOR="fairmq-ex-1-n-1-processor"
    PROCESSOR+=" --id processor$i"
    PROCESSOR+=" --transport $transport"
    PROCESSOR+=" --verbosity veryhigh"
    PROCESSOR+=" --severity debug"
    PROCESSOR+=" --session $SESSION"
    PROCESSOR+=" --control static --color false"
    PROCESSOR+=" --mq-config $ex2config"
    PROCESSOR+=" --config-key processor"
    @CMAKE_CURRENT_BINARY_DIR@/$PROCESSOR &
    pids+=($!)
((i++))
done

SINK="fairmq-ex-1-n-1-sink"
SINK+=" --id sink1"
SINK+=" --transport $transport"
SINK+=" --verbosity veryhigh"
SINK+=" --severity debug"
SINK+=" --session $SESSION"
SINK+=" --control static --color false"
# SINK+=" --max-iterations 2"
SINK+=" --mq-config $ex2config"
@CMAKE_CURRENT_BINARY_DIR@/$SINK &
SINK_PID=$!

sleep 5

i=0
while [ $i -le 19 ]
do
    sleep 1
    echo "......................"
    echo "killing processor$i..."
    kill -SIGINT ${pids[$i]}
    wait ${pids[$i]}
    echo "killed processor$i   !"
    echo "......................"
((i++))
done

kill -SIGINT $SAMPLER_PID
kill -SIGINT $SINK_PID

wait $SAMPLER_PID
wait $SINK_PID
